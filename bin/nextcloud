#!/bin/bash

set -e

if [[ ! -f .env ]]; then
    FIRST_RUN=1

    echo "Generating a configuration file."

    DEFAULT_DOMAIN_NAME="localhost"
    DEFAULT_ADMIN_USER="admin"

    read -p "Domain name [$DEFAULT_DOMAIN_NAME]: " DOMAIN_NAME
    read -p "Nextcloud admin username [$DEFAULT_ADMIN_USER]: " ADMIN_USER

    DOMAIN_NAME="${DOMAIN_NAME:-$DEFAULT_DOMAIN_NAME}"
    ADMIN_USER="${ADMIN_USER:-$DEFAULT_ADMIN_USER}"

    if ! command -v pwgen &> /dev/null; then
        echo "Installing pwgen to generate passwords..."
        sudo apt-get install pwgen -y
    fi

    ADMIN_PASSWORD="$(pwgen -s 32)"

    echo "# Configuration generated by $USER on $(date)" > .env
    echo "DOMAIN_NAME=$DOMAIN_NAME" >> .env
    echo "NEXTCLOUD_ADMIN_USER=$ADMIN_USER" >> .env
    echo "NEXTCLOUD_INITIAL_ADMIN_PASSWORD=$ADMIN_PASSWORD" >> .env
    echo "POSTGRES_PASSWORD=$(pwgen -s 32)" >> .env
fi

if ! command -v docker &> /dev/null; then
    echo "Installing Docker..."
    if ! command -v curl &> /dev/null; then
        sudo apt-get install curl -y
    fi

    curl -fsSL https://get.docker.com | sudo sh

    # https://docs.docker.com/engine/install/linux-postinstall/
    sudo usermod -aG docker $USER
fi

echo "Starting Nextcloud..."
sudo -u $USER docker compose up --build --wait

if [[ "$FIRST_RUN" ]]; then
    echo
    echo "Started Nextcloud at https://$DOMAIN_NAME"
    echo
    echo "Username: $ADMIN_USER"
    echo "Password: $ADMIN_PASSWORD"
    echo
    echo "Change this password here: https://$DOMAIN_NAME/settings/user/security"
    echo
fi
